% !TeX root = article.tex
\section{Adding plasticity to physics engine}

In this section, key concepts related to the introduced model are explained. Main differences between 
traditional structural analysis and physics engines are reviewed and discussed.

Velocity-based formulation is not often used in structural or mechanical engineering while, 
however, it is popular within physics based game developers and film production teams.
 \citet[p.~45]{erleben.thesis} provides reasoning and theoretical details on why 
velocity-based formulation is  popular in constraint-based rigid body simulation. 
Main reason is that collision handling can be done without additional procedures.
Acceleration-based formulations need to stop at collision and switch to an impulse based method.

Background
for velocity based formulation shown here is based on  \citet[p.~45-50]{erleben.thesis}.
% pdf page 64
In following section, these formulations will be clarified by simple example using \bullet\ implementation.
Assuming that force $\vec{f}_{true}(t)$, is known the impulse $\vec{J}$
in the time interval $\Delta t $ can we written as
\begin{equation} \label{eq:impulseIntegral}
\vec{J} = \int_{0}^{\Delta t} \vec{f}_{true}(t) dt
\end{equation}
Using Newton's second law of motion $F=ma$ one can solve for the velocity, $\vec{v}^{\Delta t}$
\begin{equation} \label{eq:impulseIntegraWithNewton}
\int_{0}^{\Delta t} m \frac{d\vec{v}}{dt}dt= \int_{0}^{\Delta t} \vec{f}_{true}(t)
\end{equation}
\begin{equation} \label{eq:impulse}
m(\vec{v}^{\, \Delta t} - \vec{v}^{\, 0})=\vec{J}
\end{equation}
where superscripts denote time, i.e. ${v}^{\Delta t}=v(\Delta t)$. Next position can be found
by integrating the velocity.
Derivation of equations of motion is not shown here in detail but results 
for simple contact can be summarized as
equation \ref{eq:eomL} for locations and \ref{eq:eomV} for velocities.
Symbols are summarized in table \ref{tab:eom} and figure \ref{fig:eom}.
\begin{equation} \label{eq:eomL} % pdf page 69
\vec{s}^{\, t+\Delta t} = \vec{s}^{\, t}+\Delta t S \vec{u}^{\, t+\Delta t}
\end{equation}

\begin{equation} \label{eq:eomV}
\vec{u}^{\, t+\Delta t} = \vec{u}^{\, t}+\Delta t M^{-1}(C N \vec{f}^{\ t+\Delta t} + \vec{f}_{ext}) 
\end{equation}

Friction in contacts and joint constraints can be handled in unified way by refactoring
equation \ref{eq:eomV} to get \ref{eq:eomV2},  \citet[p.~66-67]{erleben.thesis}.
Jacobian terms are derived by taking time derivates of kinematic constraints.

\begin{equation} \label{eq:eomV2}
\vec{u}^{\, t+\Delta t} = \vec{u}^{\, t}+\Delta t M^{-1}(
 J_{contact}^T \vec{\lambda}_{contact}
+ J_{joint}^T \vec{\lambda}_{joint}
+ \vec{f}_{ext})
\end{equation}


\begin{figure}[htb!]
\centering
\begin{tikzpicture}
\coordinate (O1) at(2,1);
\coordinate (O2) at(2,4);
\coordinate (C) at(2,2);
\draw (0,0) -- (4,0) -- (4,2) -- (0,2) --(0,0);
\draw (2,2) -- (3.5,5) -- (0.5,5) -- (2,2) ;
\node at (3.5,0.4) {$B_1$};
\filldraw (O1) circle (0.5mm) node[anchor=north] {$\vec{r}_1$};
\node at (2.8,4.5) {$B_2$};
\filldraw (O2) circle (0.5mm) node[anchor=south] {$\vec{r}_2$};
\filldraw (C) circle (0.5mm) node[anchor=north west] {$\vec{p}_1$};
\draw[-{Stealth[length=3mm]}] (O1) -- (C) node[anchor=north east] {$\vec{r}_{11}$};
\draw[-{Stealth[length=3mm]}] (O2) -- (C) node[anchor=south east] {$\vec{r}_{21}$};
\draw[-latex,thick] (C) -- ++(0,1.4) node[anchor=west] {$\vec{n}_{1}$};
\node[anchor=west] at (4.5,4.5) {
$\vec{r}_i$  =  orientation of body i 
};
\node[anchor=west] at (4.5,4) {$\vec{p}_k $ = orientation of contact point k};
\node[anchor=west] at (4.5,3.5) {$\vec{r}_{ik} $ = $\vec{p}_k - \vec{r}_i $};
\node[anchor=west] at (4.5,3) {$\vec{n}_{k} $ = normal for contact point k };
\end{tikzpicture}
\caption{Illustration of nomenclature for equations of motion for contact.}
\label{fig:eom-contact}
\end{figure}

\begin{figure}[htb!]
\centering
\begin{tikzpicture}
\coordinate (O1) at(1,1);
\coordinate (O2) at(1,3);
\coordinate (C) at(1,2);
\draw (0,0) -- (2,0) -- (2,2) -- (0,2) --(0,0);
\draw (0,2) -- (2,2) -- (2,4) -- (0,4) --(0,2) ;
\node at (0.5,0.4) {$B_1$};
\filldraw (O1) circle (0.5mm) node[anchor=north] {$\vec{r}_1$};
\node at (0.5,3.5) {$B_2$};
\filldraw (O2) circle (0.5mm) node[anchor=south] {$\vec{r}_2$};
\filldraw (C) circle (0.5mm) node[anchor=north west] {$\vec{p}_1$};
\draw[-{Stealth[length=3mm]}] (O1) -- (C) node[anchor=north east] {$\vec{r}_{11}$};
\draw[-{Stealth[length=3mm]}] (O2) -- (C) node[anchor=south east] {$\vec{r}_{21}$};
\node[anchor=west] at (4.5,4.5) {
$\vec{r}_i$  =  orientation of body i 
};
\node[anchor=west] at (4.5,4) {$\vec{p}_k $ = orientation of joint point k};
\node[anchor=west] at (4.5,3.5) {$\vec{r}_{ik} $ = $\vec{p}_k - \vec{r}_i $};
\end{tikzpicture}
\caption{Illustration of nomenclature for equations of motion for joint.}
\label{fig:eom-joint}
\end{figure}


% pdf page 33, notation in typical ODEs
\begin {table}[htb!]
\begin{center}
\begin{tabular}{|l| l|}
\hline
{\bf Symbol} & {\bf Description} \\  \hline
$\vec{r}_i$ & position of center of mass for body i  \\ \hline
$\vec{q}_i$ & orientation as a quaternion for body i  (\ref{eq:vectorqi})  \\ \hline
$\vec{p}_i$ & contact or joint point i  \\ \hline
$\vec{r}_{ki}$ & $\vec{p}_k - \vec{r}_i$  \\ \hline
$\vec{s}$ & $\lbrack \vec{r}_1, \vec{q}_1,...,\vec{r}_n, \vec{q}_n \rbrack ^T $\\ \hline
$Q_i$ & rotation matrix $Q_i \in  \mathbb{R}^{4 \times 3}$ (\ref{eq:matrixQi})  \\ \hline
$S$ & generalized transformation matrix $ S \in \mathbb{R}^{7n \times 6n}$ (\ref{eq:matrixS}) \\ \hline
$\vec{v}_i$ & linear velocity of  center of mass for body i   \\ \hline
$\vec{\omega}_i$ & angular velocity of center of mass for body i  \\ \hline
$\vec{u}$ & $\lbrack \vec{v}_1, \vec{\omega}_1,...,\vec{v}_n, \vec{\omega}_n \rbrack ^T $\\ \hline
$M$ & generalized mass matrix $ M \in \mathbb{R}^{6n \times 6n}$ (\ref{eq:matrixM})\\ \hline
$I_i$ & inertia tensor for body i  \\ \hline
$C$ & contact condition matrix  $ C \in \mathbb{R}^{6n \times 3K}$ \\ \hline
$N$ & contact normal matrix  $ N \in \mathbb{R}^{3K \times K}$  (\ref{eq:matrixN}) \\ \hline
$J_{contact}$ & Jacobian matrix for contacts  \\ \hline
$\lambda_{contact}$ & vector of lagrange multipliers for contacts  \\ \hline
$J_{joint}$ & Jacobian matrix for joints  \\ \hline
$\lambda_{joint}$ & vector of lagrange multipliers for joints  \\ \hline
\end {tabular}
\end{center}
\caption {Nomenclature for equations of motion} \label{tab:eom}
\end {table}

\begin{equation} \label{eq:vectorqi}
q_i = \lbrack s_i, x_i, y_i, z_i \rbrack ^T
\end{equation}

\begin{equation} \label{eq:matrixQi} % 4.13 p 50
Q_i = \frac{1}{2} \left[ \begin{array}{ccc}
-x_i & -y_i & -z_i \\
s_i & z_i & -y_i \\
-z_i & s_i & x_i \\
y_i & -x_i & s_i
\end{array} \right]
\end{equation}

\begin{equation} \label{eq:matrixS}
S =  \left[ \begin{array}{ccccc}
1 &  &  & & 0 \\
 & Q_i  \\
 & & \ddots  \\
 & & & 1 \\
0 & & & & Q_n 
\end{array} \right]
\end{equation}

\begin{equation} \label{eq:matrixM}
M =  \left[ \begin{array}{ccccc}
m_i 1 &  &  & & 0 \\
 & I_1  \\
 & & \ddots  \\
 & & & m_n 1 \\
0 & & & & I_n 
\end{array} \right]
\end{equation}

\begin{equation} \label{eq:matrixN}
N =  \left[ \begin{array}{cccc}
\vec{n}_1 &  & & 0 \\
 & \vec{n}_2  \\
 & & \ddots  \\
0  & & & \vec{n}_k 
\end{array} \right]
\end{equation}


In structural analysis, a formulation and associated numerical solution procedure are selected 
based on needed features.
For most complex scenarios finite element method is used.
In most cases, static solution with assumption of linear strain-displacement relation small 
displacement solution using displacement based boundary conditions is used.
\citet{bathe-1975} provides description for handling of various nonlinearities.
In large displacement analysis, formulation may be based on updated formulation (Eulerian) or
Lagrangian formulation where initial configuration is used.
Further enhancements are material nonlinearity and dynamic analysis.
Physics engine provides dynamic analysis with large reference translations and rotations.

Material plasticity has typically taken into account in games by using suitable coefficient of restitution.
This provides reasonable means to simulate loss of energy in collisions.
Simulation of breaking of objects made of ductile material can be made more realistic by splitting rigid bodies
to multiple bodies which are connected by energy absorbing joints.
Typical engineering stress-strain curve of ductile steel is shown in \ref{fig:sscurve}.
E.g. \citet{dowling} provides detailed descriptions of engineering and true stress-strain curves.
Stress-strain curve is not drawn to scale as elastic strain could not be seen as it is typically 0.001 to 0.005.

In this work elastic-fully plastic material model is used in most scenarios.
It allows realistic simulations for most scenarios.
Having elastic part allows elastic displacements for slender structures. 
Elastic part is ignored in method suggested in this work if deformation is related
to higher frequency than integration stability would allow.
Strain hardening part of stress-strain curve could probably be taken into account but it has not been tried in this work.
It should be noted that geometry
of objects is not updated during analysis and thus engineering stress-strain properties should
be used even with strain hardening.

Strain hardening is taken into account in this work mainly by assuming that plasticity in bending
expands, \citet[p.~672]{dowling}.
Material that starts to yield first is hardened and yielding moves slightly.
This can be seen e.g. by bending paperclip. It does not break at low angles but can take few full bends. 

\begin{figure}[htb!]
\centering
\begin{tikzpicture}
\coordinate (Y) at (0.2,4);
\draw[->] (0,0) -- (10,0) node[right] {\large{$\epsilon$}};
\draw[->] (0,0) -- (0,6) node[above] {\large{$\sigma$}};
\draw(0,0) -- (Y) -- (2,4) .. controls (7,6) .. (10,5);
\draw[dashed](0,4) -- (Y);
\node at (-0.2,4) [align=right] {$f_y$};
\end{tikzpicture}
\caption{Engineering stress-strain curve of ductile steel (not to scale).}
\label{fig:sscurve}
\end{figure}

Difference between elastic and plastic section modulus is shown in \ref{fig:wp}. 
If stress is below yield limit, stress and strain are linear within material.
If cross section is fully plastic, stress is assumed to be at yield level over whole cross section and 
so plastic section modulus is higher than elastic section modulus.

\begin{figure}[htb!]
\centering
\begin{tikzpicture}
\coordinate (S) at (2.5,5);
\draw (0,5) -- (4,5) ;
\draw (0,0) -- (4,0) ;
\draw (2,0) -- (2,5) ;
\draw (1.5,0) -- (S); 
\node[above] at (S) [align=center] {\large{$\sigma<f_y$}};
\end{tikzpicture}
\hspace{1cm}
\begin{tikzpicture}
\coordinate (S) at (3,5);
\draw (0,5) -- (4,5) ;
\draw (0,0) -- (4,0) ;
\draw (2,0) -- (2,5) ;
\draw (1,0) -- (1,2.5) -- (3,2.5) -- (S); 
\node[above] at (S) [align=center] {\large{$\sigma=f_y$}};
\end{tikzpicture}
\caption{Stress distribution under elastic and plastic loads.}
\label{fig:wp}
\end{figure}

Basic idea in this work can be tested with any framework having motors and hinge constraints.
This can be done by setting target velocity of motor to zero and limiting maximum motor impulse to plastic moment 
multiplied by timestep.

Further enhancements were created and tested by forking \bullet\ source code
and adding new constraints \cite{pbullet}.
Constraint processing in \bullet\ is based on ODE, \cite{ode}.
Mathematical background and detailed examples are available by \cite{ode.joints}.
Joints are also discussed in detail in  \citet[p.~60-90]{erleben.thesis}.
In following section, these equations will be clarified by simple example.
Equations \ref{eq:constraintEquation}, \ref{eq:lambdaLow} and
\ref{eq:lambdaHigh} 
are created for each constraint.

\begin{equation} \label{eq:constraintEquation}
J_1 v_1 + \Omega_1 \omega_1 + J_2 v_2 + \Omega_2 \omega_2 = c + C \lambda
\end{equation}

\begin{equation} \label{eq:lambdaLow}
\lambda \geq l
\end{equation}

\begin{equation} \label{eq:lambdaHigh}
\lambda \leq h
\end{equation}

Main parameters  and corresponding fields in \bullet\  
 are described in table \ref{tab:constraintParameters}.

\begin {table}[htb!]
\begin{center}
\begin{tabular}{|c| l| l|}
\hline
{\bf Parameter} & {\bf Description} & {\bf btConstraintInfo2 pointer}\\  \hline
$J_1, \Omega_1$ & jacobian & m\_J1linearAxis, m\_J1angularAxis \\
$J_2, \Omega_2$ & & m\_J2linearAxis, m\_J2angularAxis \\ \hline
$v$ & linear velocity & \\ \hline
$\omega$ & angular velocity & \\ \hline
$c$        &  right side vector   & m\_constraintError \\ \hline
$C$  & constraint force mixing & cfm \\  \hline
$\lambda$ & constraint force &  \\ \hline
$l$ & low limit for constraint force & m\_lowerLimit \\ \hline
$h$ & high limit for constraint force & m\_upperLimit \\ \hline
\end {tabular}
\end{center}
\caption {Constraint parameters} \label{tab:constraintParameters} 
\end {table}
